<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Layer Balanced Cement Plug Calculator</title>
    <style>
        :root {
            --color-primary: #208090;
            --color-primary-hover: #1a6475;
            --color-bg: #f5f5f2;
            --color-surface: #ffffff;
            --color-text: #1f2121;
            --color-text-secondary: #626c7c;
            --color-success: #32b8c6;
            --color-error: #c01530;
            --color-warning: #a84d2f;
            --color-border: #5e5240;
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --radius-base: 8px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: var(--space-20);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
        }

        .container { max-width: 1400px; margin: 0 auto; }
        header { margin-bottom: var(--space-24); }
        h1 { margin: 0 0 var(--space-8) 0; font-size: 28px; color: var(--color-text); }
        .subtitle { color: var(--color-text-secondary); font-size: 14px; margin: 0; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: var(--space-20);
            margin-bottom: var(--space-24);
        }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius-base);
            border: 1px solid rgba(94, 82, 64, 0.15);
            padding: var(--space-20);
            box-shadow: var(--shadow-sm);
        }

        .card h2 { margin: 0 0 var(--space-16) 0; font-size: 18px; font-weight: 600; }

        .form-group { margin-bottom: var(--space-16); }
        label { display: block; margin-bottom: var(--space-8); font-size: 13px; font-weight: 500; color: var(--color-text-secondary); }

        input[type="number"], select {
            width: 100%;
            padding: var(--space-12);
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: var(--radius-base);
            font-size: 14px;
            color: var(--color-text);
            background-color: var(--color-surface);
            transition: border-color 0.2s;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(32, 128, 144, 0.2);
        }

        input[type="number"]:disabled {
            background-color: rgba(94, 82, 64, 0.08);
            color: var(--color-text-secondary);
            cursor: not-allowed;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--space-8);
            align-items: flex-end;
        }

        .unit-label {
            padding: var(--space-12);
            background-color: rgba(94, 82, 64, 0.08);
            border: 1px solid rgba(94, 82, 64, 0.15);
            border-radius: var(--radius-base);
            font-size: 13px;
            color: var(--color-text-secondary);
            min-width: 60px;
            text-align: center;
        }

        .casing-section {
            border: 1px solid rgba(32, 128, 144, 0.2);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin-bottom: var(--space-12);
            background-color: rgba(32, 128, 144, 0.03);
        }

        .casing-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-12);
        }

        .casing-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-primary);
            text-transform: uppercase;
        }

        .remove-btn {
            background-color: var(--color-error);
            color: white;
            border: none;
            padding: var(--space-8) var(--space-12);
            border-radius: var(--radius-base);
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .remove-btn:hover { background-color: #a01028; }

        .casing-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-12);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-12);
            margin-top: var(--space-16);
        }

        .result-box {
            background-color: rgba(32, 184, 198, 0.08);
            border: 1px solid rgba(32, 184, 198, 0.25);
            border-radius: var(--radius-base);
            padding: var(--space-16);
        }

        .result-label { font-size: 12px; color: var(--color-text-secondary); margin-bottom: var(--space-4); font-weight: 500; }
        .result-value { font-size: 22px; font-weight: 600; color: var(--color-primary); font-family: 'Courier New', monospace; }
        .result-unit { font-size: 11px; color: var(--color-text-secondary); margin-top: var(--space-4); }

        button {
            background-color: var(--color-primary);
            color: #ffffff;
            border: none;
            padding: var(--space-12) var(--space-20);
            border-radius: var(--radius-base);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }

        button:hover { background-color: var(--color-primary-hover); }
        button:active { transform: scale(0.98); }

        .button-group {
            display: flex;
            gap: var(--space-12);
            margin-top: var(--space-16);
        }

        .button-group button { flex: 1; }

        .add-btn {
            background-color: var(--color-success);
            width: auto;
            padding: var(--space-8) var(--space-16);
            font-size: 13px;
            margin-top: var(--space-12);
        }

        .add-btn:hover { background-color: #2aa8b0; }

        .info-box {
            background-color: rgba(50, 184, 198, 0.1);
            border: 1px solid rgba(50, 184, 198, 0.3);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin-top: var(--space-16);
            font-size: 13px;
            color: var(--color-text);
            line-height: 1.6;
        }

        .info-box strong { color: var(--color-primary); }

        .warning-box {
            background-color: rgba(168, 75, 47, 0.1);
            border: 1px solid rgba(168, 75, 47, 0.3);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            font-size: 13px;
            color: var(--color-text);
            margin-top: var(--space-16);
        }

        .warning-box strong { color: var(--color-warning); }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-16);
            font-size: 13px;
        }

        th {
            background-color: rgba(32, 128, 144, 0.08);
            border: 1px solid rgba(94, 82, 64, 0.15);
            padding: var(--space-12);
            text-align: left;
            font-weight: 600;
            color: var(--color-text);
        }

        td {
            border: 1px solid rgba(94, 82, 64, 0.15);
            padding: var(--space-12);
        }

        .tabs {
            display: flex;
            gap: var(--space-12);
            margin-bottom: var(--space-20);
            border-bottom: 1px solid rgba(94, 82, 64, 0.15);
        }

        .tab-button {
            background: none;
            border: none;
            padding: var(--space-12) var(--space-16);
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            width: auto;
        }

        .tab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .dp-section {
            background-color: rgba(168, 75, 47, 0.05);
            border: 1px solid rgba(168, 75, 47, 0.2);
            border-radius: var(--radius-base);
            padding: var(--space-16);
        }

        .dp-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-12);
            margin-bottom: var(--space-12);
        }

        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-warning);
            text-transform: uppercase;
            margin-bottom: var(--space-8);
        }

        .segments-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-16);
            font-size: 12px;
        }

        .segments-table th {
            background-color: rgba(32, 128, 144, 0.12);
            border: 1px solid rgba(32, 128, 144, 0.3);
            padding: var(--space-12);
            text-align: center;
            font-weight: 600;
            color: var(--color-text);
        }

        .segments-table td {
            border: 1px solid rgba(32, 128, 144, 0.2);
            padding: var(--space-12);
            text-align: center;
        }

        .segment-row { background-color: rgba(32, 128, 144, 0.04); }
        .segment-row:nth-child(even) { background-color: rgba(32, 128, 144, 0.08); }
        .segment-label { font-weight: 600; color: var(--color-primary); }

        .filling-bar {
            width: 100%;
            height: 24px;
            background-color: rgba(94, 82, 64, 0.1);
            border: 1px solid rgba(94, 82, 64, 0.2);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin: var(--space-4) 0;
        }

        .filling-bar-filled {
            height: 100%;
            background: linear-gradient(90deg, var(--color-success), var(--color-primary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
            transition: width 0.3s ease;
        }

        .filling-status {
            font-size: 12px;
            margin-top: var(--space-20);
            padding: var(--space-16);
            background-color: rgba(32, 128, 144, 0.05);
            border-radius: var(--radius-base);
        }

        .filling-status-item {
            display: flex;
            justify-content: space-between;
            padding: var(--space-8) 0;
            border-bottom: 1px solid rgba(32, 128, 144, 0.1);
        }

        .filling-status-item:last-child { border-bottom: none; }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            h1 { font-size: 22px; }
            .casing-row { grid-template-columns: 1fr; }
            .dp-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>Balance CMT Plug Calculator</h1>
                <p class="subtitle">Design By Amir Ghaderi</p>
            </div>
            <img src="https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/db20b6aa-7e9f-4045-b44b-5f908ed75e19" alt="NISOC Logo" style="height: 80px; width: auto; margin-left: 20px;">
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('calculator', this)">Calculator</button>
            <button class="tab-button" onclick="switchTab('reference', this)">Reference Data</button>
        </div>

        <!-- Calculator Tab -->
        <div id="calculator" class="tab-content active">
            <div class="grid">
                <!-- Well Configuration -->
                <div class="card">
                    <h2>Well Configuration</h2>
                    <div class="form-group">
                        <label for="tmDepth">Total Measured Depth (TMD)</label>
                        <div class="input-group">
                            <input type="number" id="tmDepth" placeholder="Auto-calculated" step="1" min="0" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                            <div class="unit-label">m</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="slurryVolume">Cement Slurry Volume</label>
                        <div class="input-group">
                            <input type="number" id="slurryVolume" placeholder="50" step="0.5" min="0" oninput="calculatePlug()">
                            <div class="unit-label">bbl</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cementDensity">Cement Density</label>
                        <div class="input-group">
                            <input type="number" id="cementDensity" placeholder="115.5" step="0.1" min="75" max="135" oninput="calculatePlug()">
                            <div class="unit-label">pcf</div>
                        </div>
                    </div>
                </div>

                <!-- Casing Configuration -->
                <div class="card">
                    <h2>Casing String Configuration (Upper to Lower)</h2>
                    <div id="casingContainer"></div>
                    <button class="add-btn" onclick="addCasingSection()">+ Add Casing Section</button>
                </div>

                <!-- Drillpipe Configuration -->
                <div class="card">
                    <h2>Drillpipe Configuration</h2>
                    <div class="dp-section">
                        <div class="section-label">Upper Section</div>
                        <div class="dp-row">
                            <div class="form-group">
                                <label for="dpLowerType">DP Type</label>
                                <select id="dpLowerType" onchange="calculatePlug()">
                                    <option value="">-- Select DP --</option>
                                    <option value="2.875-G105">2 7/8" DP G-105</option>
                                    <option value="3.5-S135">3 1/2" DP S-135</option>
                                    <option value="3.5-G105">3 1/2" DP G-105</option>
                                    <option value="5-S135">5" DP S-135</option>
                                    <option value="5-G105">5" DP G-105</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dpLowerLength">Length</label>
                                <div class="input-group">
                                    <input type="number" id="dpLowerLength" placeholder="600" step="1" min="0" oninput="calculatePlug()">
                                    <div class="unit-label">m</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dp-section" style="margin-top: var(--space-16);">
                        <div class="section-label">Lower Section</div>
                        <div class="dp-row">
                            <div class="form-group">
                                <label for="dpUpperType">DP Type</label>
                                <select id="dpUpperType" onchange="calculatePlug()">
                                    <option value="">-- Select DP --</option>
                                    <option value="2.875-G105">2 7/8" DP G-105</option>
                                    <option value="3.5-S135">3 1/2" DP S-135</option>
                                    <option value="3.5-G105">3 1/2" DP G-105</option>
                                    <option value="5-S135">5" DP S-135</option>
                                    <option value="5-G105">5" DP G-105</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dpUpperLength">Length</label>
                                <div class="input-group">
                                    <input type="number" id="dpUpperLength" disabled placeholder="0">
                                    <div class="unit-label">m</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="info-box" style="margin-top: var(--space-16); margin-bottom: 0;">
                        <strong>Note:</strong> Upper section auto-calculates. Both combined equal TMD.
                    </div>
                </div>

                <!-- Segments Visualization -->
                <div class="card" style="grid-column: 1 / -1;">
                    <h2 style="text-align: center;">Annulus Segments Breakdown</h2>
                    <div id="segmentsTable" style="overflow-x: auto;"></div>
                </div>

                <!-- Results -->
                <div class="card" style="grid-column: 1 / -1;">
                    <h2>Calculation Results</h2>
                    <div class="results-grid">
                        <div class="result-box">
                            <div class="result-label">Equilibrium Height</div>
                            <div class="result-value" id="equilibriumHeight">0.00</div>
                            <div class="result-unit">m from bottom</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Total Cement Used</div>
                            <div class="result-value" id="cementUsed">0.00</div>
                            <div class="result-unit">bbl</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Total Annulus</div>
                            <div class="result-value" id="totalAnnulusAvailable">0.00</div>
                            <div class="result-unit">bbl</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Total DP Capacity</div>
                            <div class="result-value" id="totalDPCapacity">0.00</div>
                            <div class="result-unit">bbl</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Cement in Annulus</div>
                            <div class="result-value" id="cementInAnnulus">0.00</div>
                            <div class="result-unit">bbl</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Cement in DP</div>
                            <div class="result-value" id="cementInDP">0.00</div>
                            <div class="result-unit">bbl</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">DP Fluid Displacement</div>
                            <div class="result-value" id="displacement" style="color: var(--color-error);">0.00</div>
                            <div class="result-unit">bbl</div>
                        </div>
                    </div>
                    <div id="segmentFillingStatus" style="margin-top: var(--space-20);"></div>
                    <div class="info-box">
                        <strong>Status:</strong> <strong id="balanceStatus">Pending calculation</strong>
                    </div>
                    <div id="warningMessage" class="warning-box" style="display: none;">
                        <strong>⚠ Warning:</strong> <span id="warningText"></span>
                    </div>
                    <div class="button-group">
                        <button onclick="calculatePlug()">Calculate</button>
                        <button onclick="resetForm()" style="background-color: rgba(94, 82, 64, 0.3); color: var(--color-text);">Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reference Tab -->
        <div id="reference" class="tab-content">
            <div class="card">
                <h2 style="margin-top: 0;">Casing Specifications</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Casing Size</th>
                            <th>Weight</th>
                            <th>ID (inch)</th>
                            <th>Capacity (bbl/m)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>9 5/8"</td><td>43.5</td><td>8.755</td><td>0.2443</td></tr>
                        <tr><td>9 5/8"</td><td>47</td><td>8.535</td><td>0.2322</td></tr>
                        <tr><td>9 5/8"</td><td>53.5</td><td>8.535</td><td>0.2322</td></tr>
                        <tr><td>7"</td><td>29</td><td>6.184</td><td>0.1219</td></tr>
                        <tr><td>7"</td><td>32</td><td>6.094</td><td>0.1184</td></tr>
                        <tr><td>8 1/2"</td><td>H.S</td><td>8.5</td><td>0.2303</td></tr>
                        <tr><td>6 1/8"</td><td>H.S</td><td>6.125</td><td>0.1196</td></tr>
                    </tbody>
                </table>
                <h2 style="margin-top: var(--space-24);">Drillpipe Specifications</h2>
                <table>
                    <thead>
                        <tr>
                            <th>DP Size</th>
                            <th>Grade</th>
                            <th>Capacity</th>
                            <th>Displacement</th>
                            <th>Combined</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>2 7/8"</td><td>G-105</td><td>0.01418</td><td>0.01253</td><td>0.02671</td></tr>
                        <tr><td>3 1/2"</td><td>S-135</td><td>0.02377</td><td>0.01817</td><td>0.04194</td></tr>
                        <tr><td>3 1/2"</td><td>G-105</td><td>0.02402</td><td>0.01754</td><td>0.04156</td></tr>
                        <tr><td>5"</td><td>S-135</td><td>0.05641</td><td>0.02691</td><td>0.08332</td></tr>
                        <tr><td>5"</td><td>G-105</td><td>0.05691</td><td>0.02635</td><td>0.08326</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const casingData = {
            '9.625-47': { id: 8.535, capacity: 0.23218, size: '9 5/8"' },
            '9.625-43.5': { id: 8.755, capacity: 0.24431, size: '9 5/8"' },
            '9.625-53.5': { id: 8.535, capacity: 0.23218, size: '9 5/8"' },
            '7-29': { id: 6.184, capacity: 0.12188, size: '7"' },
            '7-32': { id: 6.094, capacity: 0.11837, size: '7"' },
            '8.5-hs': { id: 8.5, capacity: 0.23028, size: '8 1/2"' },
            '6.125-hs': { id: 6.125, capacity: 0.11957, size: '6 1/8"' }
        };

        const dpData = {
            '2.875-G105': { capacity: 0.01418, displacement: 0.01253 },
            '3.5-S135': { capacity: 0.02377, displacement: 0.01817 },
            '3.5-G105': { capacity: 0.02402, displacement: 0.01754 },
            '5-S135': { capacity: 0.05641, displacement: 0.02691 },
            '5-G105': { capacity: 0.05691, displacement: 0.02635 }
        };

        let casingCount = 0;

        function addCasingSection() {
            casingCount++;
            const container = document.getElementById('casingContainer');
            const section = document.createElement('div');
            section.className = 'casing-section';
            section.id = 'casing-' + casingCount;
            section.innerHTML = `
                <div class="casing-section-header">
                    <span class="casing-section-title">Section ${casingCount}</span>
                    ${casingCount > 1 ? `<button class="remove-btn" onclick="removeCasingSection(${casingCount})">Remove</button>` : ''}
                </div>
                <div class="casing-row">
                    <div class="form-group">
                        <label>Casing Type</label>
                        <select id="casingType-${casingCount}" onchange="calculatePlug()">
                            <option value="">-- Select --</option>
                            <option value="9.625-47">9 5/8" CSG 47#</option>
                            <option value="9.625-43.5">9 5/8" CSG 43.5#</option>
                            <option value="9.625-53.5">9 5/8" CSG 53.5#</option>
                            <option value="7-29">7" LNR 29#</option>
                            <option value="7-32">7" LNR 32#</option>
                            <option value="8.5-hs">8 1/2" H.S</option>
                            <option value="6.125-hs">6 1/8" H.S</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Length</label>
                        <div class="input-group">
                            <input type="number" id="casingLength-${casingCount}" placeholder="500" step="1" min="0" oninput="updateTMD()">
                            <div class="unit-label">m</div>
                        </div>
                    </div>
                </div>
                <div class="casing-row">
                    <div class="form-group">
                        <label>Casing ID</label>
                        <div class="input-group">
                            <input type="text" id="casingID-${casingCount}" disabled placeholder="Auto">
                            <div class="unit-label">in</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Capacity</label>
                        <div class="input-group">
                            <input type="text" id="casingCap-${casingCount}" disabled placeholder="Auto">
                            <div class="unit-label">bbl/m</div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(section);
        }

        function removeCasingSection(id) {
            document.getElementById('casing-' + id).remove();
            updateTMD();
        }

        function createSegments(casings, dpLower, dpUpper, tmDepth) {
            let depthPoints = [0];
            casings.forEach(c => { if (c.endDepth > 0) depthPoints.push(c.endDepth); });
            depthPoints.push(dpLower.endDepth);
            depthPoints.push(tmDepth);
            depthPoints = [...new Set(depthPoints)].sort((a, b) => a - b);

            let segments = [];
            for (let i = 0; i < depthPoints.length - 1; i++) {
                let startDepth = depthPoints[i];
                let endDepth = depthPoints[i + 1];
                let casing = casings.find(c => startDepth >= c.startDepth && startDepth < c.endDepth);
                let dp = startDepth < dpLower.endDepth ? dpLower : dpUpper;

                if (casing && dp) {
                    let dpCombined = dp.capacity + dp.displacement;
                    let annulusCap = casing.capacity - dpCombined;
                    segments.push({
                        startDepth, endDepth, length: endDepth - startDepth,
                        casing, dp, annulusCapacity: Math.max(0, annulusCap)
                    });
                }
            }
            return segments.reverse();
        }

        function updateTMD() {
            let totalLength = 0;
            for (let i = 1; i <= casingCount; i++) {
                const lengthInput = document.getElementById('casingLength-' + i);
                if (lengthInput) {
                    const length = parseFloat(lengthInput.value) || 0;
                    totalLength += length;
                }
            }
            document.getElementById('tmDepth').value = totalLength;
            calculatePlug();
        }

        function calculatePlug() {
            const tmDepth = parseFloat(document.getElementById('tmDepth').value) || 0;
            const slurryVolume = parseFloat(document.getElementById('slurryVolume').value) || 0;

            let casings = [];
            let currentDepth = 0;
            for (let i = 1; i <= casingCount; i++) {
                const type = document.getElementById('casingType-' + i).value;
                const length = parseFloat(document.getElementById('casingLength-' + i).value) || 0;

                if (type && casingData[type] && length > 0) {
                    const data = casingData[type];
                    casings.push({
                        startDepth: currentDepth, endDepth: currentDepth + length,
                        type, capacity: data.capacity, displacement: 0
                    });
                    document.getElementById('casingID-' + i).value = data.id.toFixed(3);
                    document.getElementById('casingCap-' + i).value = data.capacity.toFixed(5);
                    currentDepth += length;
                }
            }

            const dpLowerType = document.getElementById('dpLowerType').value;
            const dpLowerLength = parseFloat(document.getElementById('dpLowerLength').value) || 0;
            const dpUpperType = document.getElementById('dpUpperType').value;
            const dpUpperLength = Math.max(0, tmDepth - dpLowerLength);
            document.getElementById('dpUpperLength').value = dpUpperLength.toFixed(0);

            let dpLower = { startDepth: 0, endDepth: 0, capacity: 0, displacement: 0 };
            let dpUpper = { startDepth: 0, endDepth: 0, capacity: 0, displacement: 0 };

            if (dpLowerType && dpData[dpLowerType]) {
                dpLower = {
                    startDepth: 0, endDepth: dpLowerLength,
                    capacity: dpData[dpLowerType].capacity,
                    displacement: dpData[dpLowerType].displacement
                };
            }

            if (dpUpperType && dpData[dpUpperType]) {
                dpUpper = {
                    startDepth: dpLowerLength, endDepth: tmDepth,
                    capacity: dpData[dpUpperType].capacity,
                    displacement: dpData[dpUpperType].displacement
                };
            }

            let segments = createSegments(casings, dpLower, dpUpper, tmDepth);
            let totalAnnulusVolume = 0, totalDPCapacity = 0, segmentDetails = [];

            segments.forEach(seg => {
                const dpCombined = seg.dp.capacity + seg.dp.displacement;
                const annulusCapacity = seg.casing.capacity - dpCombined;
                const combinedCapacity = annulusCapacity + seg.dp.capacity;

                totalAnnulusVolume += seg.length * annulusCapacity;
                totalDPCapacity += seg.length * seg.dp.capacity;

                segmentDetails.push({
                    startDepth: seg.startDepth, endDepth: seg.endDepth, length: seg.length,
                    casing: seg.casing.type, dp: seg.dp.startDepth === 0 && seg.dp.endDepth === dpLowerLength ? 'Lower' : 'Upper',
                    annulusPerMeter: annulusCapacity, dpPerMeter: seg.dp.capacity,
                    combinedPerMeter: combinedCapacity,
                    totalCapacity: combinedCapacity * seg.length,
                    totalAnnulus: annulusCapacity * seg.length,
                    totalDP: seg.dp.capacity * seg.length
                });
            });

            let remainingVolume = slurryVolume, equilibriumHeight = 0, fillingInfo = [];

            for (let i = 0; i < segmentDetails.length; i++) {
                const seg = segmentDetails[i];
                if (remainingVolume <= 0) break;

                if (remainingVolume >= seg.totalCapacity) {
                    equilibriumHeight += seg.length;
                    remainingVolume -= seg.totalCapacity;
                    fillingInfo.push({ segmentIndex: i, status: 'full', cementHeight: seg.length, cementVolume: seg.totalCapacity, percentFilled: 100 });
                } else {
                    const heightInSegment = remainingVolume / seg.combinedPerMeter;
                    equilibriumHeight += heightInSegment;
                    fillingInfo.push({ segmentIndex: i, status: 'partial', cementHeight: heightInSegment, cementVolume: remainingVolume, percentFilled: (remainingVolume / seg.totalCapacity) * 100 });
                    remainingVolume = 0;
                }
            }

            let cementInAnnulusTotal = 0, cementInDPTotal = 0;
            fillingInfo.forEach(fill => {
                const seg = segmentDetails[fill.segmentIndex];
                cementInAnnulusTotal += fill.cementHeight * seg.annulusPerMeter;
                cementInDPTotal += fill.cementHeight * seg.dpPerMeter;
            });

            displaySegmentsTable(segmentDetails, fillingInfo);
            displayFillingStatus(segmentDetails, fillingInfo, slurryVolume);

            let balanceStatus = 'Pending calculation';
            let warningMessage = '';

            if (!dpLowerType || dpLowerLength === 0 || casings.length === 0) {
                balanceStatus = 'Pending - Complete configuration';
            } else if (slurryVolume > (totalAnnulusVolume + totalDPCapacity)) {
                balanceStatus = 'ERROR - Slurry too large';
                warningMessage = 'Slurry exceeds total capacity.';
            } else if (equilibriumHeight < 50 && slurryVolume > 0) {
                balanceStatus = 'Insufficient plug - Height < 50m';
                warningMessage = 'Equilibrium height is less than 50m minimum.';
            } else if (slurryVolume === 0) {
                balanceStatus = 'Enter slurry volume';
            } else {
                balanceStatus = 'BALANCED ✓';
            }

            // Calculate displacement (remaining DP volume not filled with cement)
            let displacement = totalDPCapacity - cementInDPTotal;

            document.getElementById('equilibriumHeight').textContent = equilibriumHeight.toFixed(2);
            document.getElementById('cementUsed').textContent = (slurryVolume > 0 ? slurryVolume : 0).toFixed(2);
            document.getElementById('totalAnnulusAvailable').textContent = totalAnnulusVolume.toFixed(2);
            document.getElementById('totalDPCapacity').textContent = totalDPCapacity.toFixed(2);
            document.getElementById('cementInAnnulus').textContent = cementInAnnulusTotal.toFixed(2);
            document.getElementById('cementInDP').textContent = cementInDPTotal.toFixed(2);
            document.getElementById('displacement').textContent = displacement.toFixed(2);
            document.getElementById('balanceStatus').textContent = balanceStatus;

            const warningDiv = document.getElementById('warningMessage');
            if (warningMessage) {
                document.getElementById('warningText').textContent = warningMessage;
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        }

        function displaySegmentsTable(segments, fillingInfo) {
            const tableHTML = `
                <table class="segments-table">
                    <thead><tr><th>Seg</th><th>Depth (m)</th><th>Casing</th><th>DP</th><th>Ann (bbl/m)</th><th>DP (bbl/m)</th><th>Total (bbl)</th><th>Fill %</th></tr></thead>
                    <tbody>${segments.map((seg, idx) => {
                        const fill = fillingInfo.find(f => f.segmentIndex === idx);
                        const fillPercent = fill ? fill.percentFilled : 0;
                        const statusText = fill ? (fill.status === 'full' ? '100%' : fillPercent.toFixed(1) + '%') : '—';
                        return `<tr class="segment-row"><td class="segment-label">${idx + 1}</td><td>${seg.startDepth.toFixed(0)}-${seg.endDepth.toFixed(0)}</td><td>${seg.casing}</td><td>${seg.dp}</td><td>${seg.annulusPerMeter.toFixed(5)}</td><td>${seg.dpPerMeter.toFixed(5)}</td><td>${seg.totalCapacity.toFixed(2)}</td><td><div class="filling-bar"><div class="filling-bar-filled" style="width: ${fillPercent}%">${statusText}</div></div></td></tr>`;
                    }).join('')}</tbody>
                </table>
            `;
            document.getElementById('segmentsTable').innerHTML = tableHTML;
        }

        function displayFillingStatus(segments, fillingInfo, slurryVolume) {
            const statusHTML = `
                <div class="filling-status">
                    <strong style="color: var(--color-primary);">Cement Distribution (Bottom to Top):</strong>
                    ${fillingInfo.map(fill => {
                        const seg = segments[fill.segmentIndex];
                        return `<div class="filling-status-item"><span>Seg ${fill.segmentIndex + 1} (${seg.startDepth.toFixed(0)}-${seg.endDepth.toFixed(0)}m):</span><span><strong>${fill.cementVolume.toFixed(2)} bbl</strong> (${fill.cementHeight.toFixed(2)}m) ${fill.status === 'full' ? '✓' : ''}</span></div>`;
                    }).join('')}
                    <div class="filling-status-item" style="border-top: 2px solid var(--color-primary); margin-top: var(--space-8); padding-top: var(--space-12);"><strong>Total:</strong><strong style="color: var(--color-primary);">${slurryVolume.toFixed(2)} bbl</strong></div>
                </div>
            `;
            document.getElementById('segmentFillingStatus').innerHTML = statusHTML;
        }

        function resetForm() {
            document.getElementById('tmDepth').value = '';
            document.getElementById('slurryVolume').value = '';
            document.getElementById('cementDensity').value = '';
            document.getElementById('dpLowerType').value = '';
            document.getElementById('dpLowerLength').value = '';
            document.getElementById('dpUpperType').value = '';
            const container = document.getElementById('casingContainer');
            container.innerHTML = '';
            casingCount = 0;
            document.querySelectorAll('.result-value').forEach(el => { el.textContent = '0.00'; });
            document.getElementById('balanceStatus').textContent = 'Pending calculation';
            document.getElementById('warningMessage').style.display = 'none';
        }

        function switchTab(tabName, btn) {
            document.querySelectorAll('.tab-content').forEach(el => { el.classList.remove('active'); });
            document.querySelectorAll('.tab-button').forEach(el => { el.classList.remove('active'); });
            document.getElementById(tabName).classList.add('active');
            btn.classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            addCasingSection();
            updateTMD();
        });
    </script>
</body>
</html>
